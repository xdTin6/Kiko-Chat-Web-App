<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kiko Chat — Ephemeral</title>

<script type="module">
/* ----------------- FIREBASE SDK ----------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import {
  getDatabase, ref as dbRef, push, onChildAdded, remove, set, get, child, update, onValue, onDisconnect
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

/* ====== YOUR FIREBASE CONFIG ====== */
const firebaseConfig = {
  apiKey: "AIzaSyAe_ZfZ8rKCke47UeA9Kcs8cXpD6-G6RAQ",
  authDomain: "kiko-chat-b6435.firebaseapp.com",
  databaseURL: "https://kiko-chat-b6435-default-rtdb.firebaseio.com",
  projectId: "kiko-chat-b6435",
  storageBucket: "kiko-chat-b6435.appspot.com",
  messagingSenderId: "896370793240",
  appId: "1:896370793240:web:3f14442a5d80cd71fb1c6d",
  measurementId: "G-FB55ZBH15N"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const USERS_PATH = "users";
const ROOM_PATH = "rooms/room1/messages";
const usersRef = dbRef(db, USERS_PATH);
const roomRef = dbRef(db, ROOM_PATH);

let state = { currentUser: null, userMap: {} };

/* Helpers */
function mkKey(name){ return String(name||"").trim().toLowerCase(); }
function colorFromName(name){ let h=0;for(let i=0;i<name.length;i++)h=name.charCodeAt(i)+((h<<5)-h);return `hsl(${Math.abs(h%360)},70%,45%)`; }
function fmtTime(ts){ return new Date(ts).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}); }
function lastSeenText(ts){ if(!ts)return"last seen unknown";const d=Math.floor((Date.now()-ts)/1000);if(d<10)return"online";if(d<60)return`${d}s ago`;if(d<3600)return`${Math.floor(d/60)}m ago`;if(d<86400)return`${Math.floor(d/3600)}h ago`;return `${Math.floor(d/86400)}d ago`; }

/* Presence */
async function setPresence(username){
  const statusRef=dbRef(db,`${USERS_PATH}/${username}/status`);
  await set(statusRef,{online:true,lastSeen:Date.now()});
  onDisconnect(statusRef).set({online:false,lastSeen:Date.now()});
}

/* Users */
async function createUser(username,pass,role="user"){
  const k=mkKey(username); if(!k)return;
  await set(child(usersRef,k),{pass:String(pass),role});
}
async function loadUsers(){
  const snap=await get(usersRef); if(!snap.exists())return;
  state.userMap=snap.val(); updateUsersUI();
}
function updateUsersUI(){
  const ul=document.getElementById("usersList"); ul.innerHTML="";
  for(const [username,info] of Object.entries(state.userMap)){
    const row=document.createElement("div"); row.className="userItem";
    const av=document.createElement("div"); av.className="miniAvatar";
    if(info.avatar){ av.style.backgroundImage=`url('${info.avatar}')`; av.style.backgroundSize="cover"; }
    else { av.style.background=colorFromName(username); av.textContent=username[0].toUpperCase(); }
    const nm=document.createElement("div"); nm.className="userName"; nm.textContent=username;
    const st=document.createElement("div"); st.className="userStatus";
    st.textContent=info.status&&info.status.online?"online":lastSeenText(info.status?.lastSeen);
    row.append(av,nm,st); ul.appendChild(row);
  }
}

/* Messages */
async function sendTextMessage(txt){
  if(!state.currentUser)return;
  const msg={type:"text",name:state.currentUser.name,text:txt,ts:Date.now(),
    deliveredBy:{[state.currentUser.name]:true},seenBy:{}};
  await push(roomRef,msg);
}
async function uploadAndSendFile(file){
  if(!state.currentUser)return;
  const isImg=file.type.startsWith("image/"),isVid=file.type.startsWith("video/");
  if(!isImg&&!isVid)return alert("only img/video");
  const reader=new FileReader();
  reader.onload=async e=>{
    const msg={type:isVid?"video":"image",name:state.currentUser.name,
      data:e.target.result,filename:file.name,ts:Date.now(),
      deliveredBy:{[state.currentUser.name]:true},seenBy:{}};
    await push(roomRef,msg);
  };
  reader.readAsDataURL(file);
}
async function markDelivered(k){ if(state.currentUser) await set(dbRef(db,`${ROOM_PATH}/${k}/deliveredBy/${state.currentUser.name}`),true);}
async function markSeen(k){ if(state.currentUser) await set(dbRef(db,`${ROOM_PATH}/${k}/seenBy/${state.currentUser.name}`),true); }

/* Render */
function renderMessage(key,msg){
  const messages=document.getElementById("messages");
  const wrap=document.createElement("div"); wrap.className="msgRow "+(msg.name===state.currentUser?.name?"me":"other");
  const av=document.createElement("div"); av.className="avatar"; av.style.background=colorFromName(msg.name||"?"); av.textContent=(msg.name||"?")[0].toUpperCase();
  const bubble=document.createElement("div"); bubble.className="bubble";
  const meta=document.createElement("div"); meta.className="meta"; meta.textContent=`${msg.name} · ${fmtTime(msg.ts)}`; bubble.appendChild(meta);
  if(msg.type==="image"){ const i=document.createElement("img");i.src=msg.data;i.className="chat-img";bubble.appendChild(i);
    const dl=document.createElement("a");dl.href=msg.data;dl.download=msg.filename||"img.png";dl.textContent="⬇️ Download";dl.className="dl";bubble.appendChild(dl);}
  else if(msg.type==="video"){ const v=document.createElement("video");v.src=msg.data;v.controls=true;v.className="chat-video";bubble.appendChild(v);
    const dl=document.createElement("a");dl.href=msg.data;dl.download=msg.filename||"vid.mp4";dl.textContent="⬇️ Download";dl.className="dl";bubble.appendChild(dl);}
  else { const t=document.createElement("div");t.textContent=msg.text||"";bubble.appendChild(t);}
  const ticks=document.createElement("div");ticks.className="ticks";
  if(state.currentUser&&msg.name===state.currentUser.name){
    const del=Object.keys(msg.deliveredBy||{}).length, seen=Object.keys(msg.seenBy||{}).filter(u=>u!==msg.name).length;
    ticks.textContent=seen>0?"✓✓":"✓"+(del>1?"✓":"");
    ticks.style.color=seen>0?"#2ea1ff":"#aaa";
  }
  bubble.appendChild(ticks);
  wrap.append(av,bubble); messages.appendChild(wrap); messages.scrollTop=messages.scrollHeight;
  if(state.currentUser&&msg.name!==state.currentUser.name){ markDelivered(key); markSeen(key); }
}

/* Listeners */
function attachListeners(){
  onChildAdded(roomRef,s=>{renderMessage(s.key,s.val());});
  onValue(usersRef,s=>{if(s.exists()){state.userMap=s.val();updateUsersUI();}});
}

/* Login */
async function loginFlow(raw,pass){
  const u=mkKey(raw); const snap=await get(child(usersRef,u));
  if(!snap.exists())return alert("User not found");
  const d=snap.val(); if(d.pass!==pass)return alert("Wrong pass");
  state.currentUser={name:u,role:d.role}; localStorage.setItem("chat_user",JSON.stringify(state.currentUser));
  await setPresence(u);
  document.getElementById("loginPane").style.display="none";
  document.getElementById("mainWrap").style.display="grid";
  document.getElementById("meName").textContent=u; document.getElementById("meRole").textContent=d.role;
  if(d.role==="admin")document.getElementById("adminPanel").style.display="block";
  await loadUsers(); attachListeners();
}

/* Restore */
window.addEventListener("load",async()=>{
  const stored=localStorage.getItem("chat_user");
  if(stored){state.currentUser=JSON.parse(stored);await setPresence(state.currentUser.name).catch(()=>{});document.getElementById("loginPane").style.display="none";document.getElementById("mainWrap").style.display="grid";document.getElementById("meName").textContent=state.currentUser.name;document.getElementById("meRole").textContent=state.currentUser.role;attachListeners();}
});

window.Kiko={login:loginFlow,createUser,sendTextMessage,uploadAndSendFile,clearChat:async()=>{await remove(roomRef);document.getElementById("messages").innerHTML="";}};
</script>

<style>
:root{--bg:#0b0d10;--panel:rgba(20,20,22,.85);--accent:#5b9dff;--muted:#9aa3b2;}
body{margin:0;background:var(--bg);height:100vh;display:flex;align-items:center;justify-content:center;color:#eee;font-family:Inter;}
#mainWrap{width:96%;height:90vh;border-radius:12px;overflow:hidden;display:grid;grid-template-columns:260px 1fr;gap:18px;padding:18px}
.left{background:var(--panel);border-radius:10px;padding:14px;display:flex;flex-direction:column;gap:12px}
#usersList{flex:1;overflow:auto}
.userItem{display:flex;gap:10px;align-items:center;padding:6px}
.miniAvatar{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
.userStatus{font-size:12px;color:var(--muted)}
.right{display:flex;flex-direction:column;gap:12px}
.topbar{display:flex;justify-content:space-between;align-items:center;background:var(--panel);padding:8px;border-radius:10px}
#messages{flex:1;overflow:auto;display:flex;flex-direction:column;gap:12px}
.msgRow{display:flex;gap:10px;align-items:flex-end;max-width:85%}
.msgRow.me{margin-left:auto;flex-direction:row-reverse}
.avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
.bubble{padding:10px 14px;border-radius:12px;background:rgba(255,255,255,.1);max-width:60%}
.msgRow.me .bubble{background:var(--accent);color:#fff}
.meta{font-size:12px;color:var(--muted);margin-bottom:6px}
.chat-img,.chat-video{max-width:260px;border-radius:8px;display:block}
.dl{font-size:12px;color:var(--muted)}
.ticks{font-size:12px;margin-top:4px}
.composer{display:flex;gap:8px;background:var(--panel);padding:8px;border-radius:8px}
.composer input{flex:1;border:none;border-radius:6px;padding:8px}
</style>
</head>
<body>
<div id="mainWrap" style="display:none">
  <div class="left">
    <div id="usersList"></div>
    <div id="adminPanel" style="display:none">
      <input id="newUsername" placeholder="username"/><input id="newPass" placeholder="pass"/>
      <button onclick="Kiko.createUser(newUsername.value,newPass.value)">Create User</button>
      <button onclick="Kiko.createUser(newUsername.value,newPass.value,'admin')">Create Admin</button>
      <button onclick="Kiko.clearChat()">Clear Chat</button>
    </div>
  </div>
  <div class="right">
    <div class="topbar"><div><span id="meName"></span> <span id="meRole"></span></div><button onclick="localStorage.clear();location.reload()">Logout</button></div>
    <div id="messages"></div>
    <div class="composer">
      <input id="textInput" placeholder="Type message"/><button onclick="Kiko.sendTextMessage(textInput.value);textInput.value=''">Send</button>
      <input type="file" id="fileInput" accept="image/*,video/*" hidden/>
      <button onclick="fileInput.click()">📎</button>
    </div>
  </div>
</div>
<div id="loginPane">
  <input id="usernameLogin" placeholder="username"/><input id="passLogin" placeholder="pass" type="password"/>
  <button onclick="Kiko.login(usernameLogin.value,passLogin.value)">Login</button>
</div>
<script>fileInput.onchange=()=>{if(fileInput.files[0])Kiko.uploadAndSendFile(fileInput.files[0])}</script>
</body>
</html>
