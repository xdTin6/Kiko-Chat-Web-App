<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KikoChat</title>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import {
  getDatabase, ref as dbRef, push, onChildAdded, remove, set, get, child, update, onValue, onDisconnect
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAe_ZfZ8rKCke47UeA9Kcs8cXpD6-G6RAQ",
  authDomain: "kiko-chat-b6435.firebaseapp.com",
  databaseURL: "https://kiko-chat-b6435-default-rtdb.firebaseio.com",
  projectId: "kiko-chat-b6435",
  storageBucket: "kiko-chat-b6435.appspot.com",
  messagingSenderId: "896370793240",
  appId: "1:896370793240:web:3f14442a5d80cd71fb1c6d",
  measurementId: "G-FB55ZBH15N"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const USERS_PATH = "users";
const ROOM_PATH = "rooms/room1/messages";
const usersRef = dbRef(db, USERS_PATH);
const roomRef = dbRef(db, ROOM_PATH);

let state = { currentUser: null, userMap: {} };

/* Helpers */
function mkKey(name){ return String(name||"").trim().toLowerCase(); }
function colorFromName(name){ let h=0;for(let i=0;i<name.length;i++)h=name.charCodeAt(i)+((h<<5)-h);return `hsl(${Math.abs(h%360)},70%,45%)`; }
function fmtTime(ts){ return new Date(ts).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}); }
function lastSeenText(ts){ if(!ts)return"last seen";const d=Math.floor((Date.now()-ts)/1000);if(d<10)return"online";if(d<60)return`${d}s ago`;if(d<3600)return`${Math.floor(d/60)}m ago`;if(d<86400)return`${Math.floor(d/3600)}h ago`;return `${Math.floor(d/86400)}d ago`; }

/* Presence */
async function setPresence(username){
  const statusRef=dbRef(db,`${USERS_PATH}/${username}/status`);
  await set(statusRef,{online:true,lastSeen:Date.now()});
  onDisconnect(statusRef).set({online:false,lastSeen:Date.now()});
}

/* Users */
async function createUser(username,pass,role="user"){
  const k=mkKey(username); if(!k)return;
  await set(child(usersRef,k),{pass:String(pass),role});
}
function updateUsersUI(){
  const ul=document.getElementById("usersList"); ul.innerHTML="";
  for(const [username,info] of Object.entries(state.userMap)){
    const row=document.createElement("div"); row.className="userItem";
    const av=document.createElement("div"); av.className="miniAvatar"; av.style.background=colorFromName(username); av.textContent=username[0].toUpperCase();
    const box=document.createElement("div"); box.style.display="flex";box.style.flexDirection="column";
    const nm=document.createElement("div"); nm.className="userName"; nm.textContent=username;
    const st=document.createElement("div"); st.className="userStatus"; st.textContent=info.status&&info.status.online?"online":lastSeenText(info.status?.lastSeen);
    box.append(nm,st); row.append(av,box); ul.appendChild(row);
  }
}

/* Messages */
async function sendTextMessage(txt){
  if(!state.currentUser)return;
  const msg={type:"text",name:state.currentUser.name,text:txt,ts:Date.now(),
    deliveredBy:{[state.currentUser.name]:true},seenBy:{}};
  await push(roomRef,msg);
}
async function uploadAndSendFile(file){
  if(!state.currentUser)return;
  const isImg=file.type.startsWith("image/"),isVid=file.type.startsWith("video/");
  if(!isImg&&!isVid)return alert("only img/video");
  const reader=new FileReader();
  reader.onload=async e=>{
    const msg={type:isVid?"video":"image",name:state.currentUser.name,
      data:e.target.result,filename:file.name,ts:Date.now(),
      deliveredBy:{[state.currentUser.name]:true},seenBy:{}};
    await push(roomRef,msg);
  };
  reader.readAsDataURL(file);
}
async function markDelivered(k){ if(state.currentUser) await set(dbRef(db,`${ROOM_PATH}/${k}/deliveredBy/${state.currentUser.name}`),true);}
async function markSeen(k){ if(state.currentUser) await set(dbRef(db,`${ROOM_PATH}/${k}/seenBy/${state.currentUser.name}`),true); }

function renderMessage(key,msg){
  const messages=document.getElementById("messages");
  const wrap=document.createElement("div"); wrap.className="msgRow "+(msg.name===state.currentUser?.name?"me":"other");
  const av=document.createElement("div"); av.className="avatar"; av.style.background=colorFromName(msg.name||"?"); av.textContent=(msg.name||"?")[0].toUpperCase();
  const bubble=document.createElement("div"); bubble.className="bubble";
  const meta=document.createElement("div"); meta.className="meta"; meta.textContent=`${msg.name} · ${fmtTime(msg.ts)}`; bubble.appendChild(meta);
  if(msg.type==="image"){ const i=document.createElement("img");i.src=msg.data;i.className="chat-img";bubble.appendChild(i);}
  else if(msg.type==="video"){ const v=document.createElement("video");v.src=msg.data;v.controls=true;v.className="chat-video";bubble.appendChild(v);}
  else { const t=document.createElement("div");t.textContent=msg.text||"";bubble.appendChild(t);}
  const ticks=document.createElement("div");ticks.className="ticks";
  if(state.currentUser&&msg.name===state.currentUser.name){
    const del=Object.keys(msg.deliveredBy||{}).length, seen=Object.keys(msg.seenBy||{}).filter(u=>u!==msg.name).length;
    ticks.textContent=seen>0?"✓✓":"✓"; ticks.style.color=seen>0?"#2ea1ff":"#aaa";
  }
  bubble.appendChild(ticks);
  wrap.append(av,bubble); messages.appendChild(wrap); messages.scrollTop=messages.scrollHeight;
  if(state.currentUser&&msg.name!==state.currentUser.name){ markDelivered(key); markSeen(key); }
}

/* Listeners */
function attachListeners(){
  onChildAdded(roomRef,s=>{renderMessage(s.key,s.val());});
  onValue(usersRef,s=>{if(s.exists()){state.userMap=s.val();updateUsersUI();}});
}

/* Login */
async function loginFlow(raw,pass){
  const u=mkKey(raw); const snap=await get(child(usersRef,u));
  if(!snap.exists())return alert("User not found");
  const d=snap.val(); if(d.pass!==pass)return alert("Wrong pass");
  state.currentUser={name:u,role:d.role}; localStorage.setItem("chat_user",JSON.stringify(state.currentUser));
  await setPresence(u);
  document.getElementById("loginPane").style.display="none";
  document.getElementById("mainWrap").style.display="grid";
  document.getElementById("meName").textContent=u; document.getElementById("meRole").textContent=d.role;
  if(d.role==="admin")document.getElementById("adminPanel").style.display="block";
  attachListeners();
}

/* Restore */
window.addEventListener("load",async()=>{
  const stored=localStorage.getItem("chat_user");
  if(stored){state.currentUser=JSON.parse(stored);await setPresence(state.currentUser.name).catch(()=>{});document.getElementById("loginPane").style.display="none";document.getElementById("mainWrap").style.display="grid";document.getElementById("meName").textContent=state.currentUser.name;document.getElementById("meRole").textContent=state.currentUser.role;attachListeners();}
});

window.Kiko={login:loginFlow,createUser,sendTextMessage,uploadAndSendFile,clearChat:async()=>{await remove(roomRef);document.getElementById("messages").innerHTML="";}};
</script>

<style>
/* 🎨 Polished Glassmorphism UI */
*{box-sizing:border-box;margin:0;padding:0;font-family:"Inter",system-ui,sans-serif;}
body,html{height:100%;overflow:hidden;}
body{
  display:flex;align-items:center;justify-content:center;
  background:linear-gradient(-45deg,#1e1e2f,#232346,#0b0d10,#111827);
  background-size:400% 400%;animation:gradientMove 18s ease infinite;
  color:#fff;
}
@keyframes gradientMove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
#mainWrap,#loginCard{
  backdrop-filter:blur(20px) saturate(160%);
  -webkit-backdrop-filter:blur(20px) saturate(160%);
  background:rgba(255,255,255,0.08);
  border-radius:24px;border:1px solid rgba(255,255,255,0.15);
  box-shadow:0 8px 30px rgba(0,0,0,0.4);
}
.logoWrap{display:flex;align-items:center;gap:12px;justify-content:center;margin-bottom:20px}
.logoCat{width:64px;height:64px;border-radius:20px;background:#5b9dff;display:flex;align-items:center;justify-content:center;font-size:34px;animation:bounce 2.5s infinite;box-shadow:0 4px 12px rgba(0,0,0,.4);}
@keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
.logoText{font-size:28px;font-weight:800;letter-spacing:1px}
#loginPane{display:flex;align-items:center;justify-content:center;width:100%;height:100%}
#loginCard{padding:32px;width:360px;text-align:center}
#loginCard input{width:100%;padding:12px 14px;margin:8px 0;border:none;border-radius:18px;background:rgba(255,255,255,.12);color:#fff;font-size:15px;outline:none;}
#loginCard button{margin-top:12px;width:100%;padding:12px;border:none;border-radius:18px;background:#5b9dff;color:#fff;font-weight:600;font-size:15px;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.4);transition:0.25s;}
#loginCard button:hover{background:#4786e6;}
#mainWrap{width:96%;height:90vh;display:grid;grid-template-columns:260px 1fr;gap:18px;padding:18px;}
.leftPanel,.rightPanel{backdrop-filter:blur(20px) saturate(160%);background:rgba(255,255,255,0.08);border-radius:20px;border:1px solid rgba(255,255,255,0.15);box-shadow:0 8px 30px rgba(0,0,0,0.35);}
.leftPanel{display:flex;flex-direction:column;overflow:hidden}
#usersList{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
.userItem{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:16px;cursor:pointer;transition:0.25s;}
.userItem:hover{background:rgba(255,255,255,0.08);}
.miniAvatar{width:40px;height:40px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;background:#5b9dff;}
.userName{font-weight:600;}
.userStatus{font-size:12px;color:#aaa}
.rightPanel{display:flex;flex-direction:column;}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.1);}
#messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;}
.msgRow{display:flex;gap:12px;align-items:flex-end;max-width:75%}
.msgRow.me{margin-left:auto;flex-direction:row-reverse}
.avatar{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;background:#5b9dff;flex-shrink:0;}
.bubble{padding:12px 16px;border-radius:20px;background:rgba(255,255,255,0.12);color:#fff;box-shadow:0 4px 14px rgba(0,0,0,0.25);max-width:420px;}
.msgRow.me .bubble{background:#5b9dff;color:#fff}
.meta{font-size:12px;color:#bbb;margin-bottom:6px}
.chat-img,.chat-video{max-width:100%;border-radius:12px;margin-top:6px}
.ticks{margin-left:8px;font-size:12px;opacity:0.9}
.composer{display:flex;gap:10px;align-items:center;padding:12px 16px;border-top:1px solid rgba(255,255,255,0.1);}
.composer input{flex:1;padding:12px;border:none;border-radius:16px;background:rgba(255,255,255,0.12);color:#fff;font-size:15px;outline:none;}
.composer button{padding:12px 16px;border:none;border-radius:16px;background:#5b9dff;color:#fff;font-weight:600;cursor:pointer;transition:0.25s;}
.composer button:hover{background:#4786e6;}
@media(max-width:900px){#mainWrap{grid-template-columns:1fr}.leftPanel{display:none}}
</style>
</head>
<body>

<!-- Login -->
<div id="loginPane">
  <div id="loginCard">
    <div class="logoWrap"><div class="logoCat">🐱</div><div class="logoText">KikoChat</div></div>
    <input id="usernameLogin" placeholder="Username"/>
    <input id="passLogin" type="password" placeholder="Passcode"/>
    <button onclick="Kiko.login(usernameLogin.value,passLogin.value)">Login</button>
  </div>
</div>

<!-- Chat -->
<div id="mainWrap" style="display:none">
  <div class="leftPanel">
    <div class="logoWrap" style="margin:16px auto;"><div class="logoCat">🐱</div><div class="logoText" style="font-size:20px">KikoChat</div></div>
    <div id="usersList"></div>
    <div id="adminPanel" style="display:none;padding:10px">
      <input id="newUsername" placeholder="username"/><input id="newPass" placeholder="pass"/>
      <button onclick="Kiko.createUser(newUsername.value,newPass.value)">+User</button>
      <button onclick="Kiko.createUser(newUsername.value,newPass.value,'admin')">+Admin</button>
      <button onclick="Kiko.clearChat()">Clear Chat</button>
    </div>
  </div>
  <div class="rightPanel">
    <div class="topbar"><div><strong id="meName"></strong> <span id="meRole" style="color:#bbb;font-size:14px"></span></div><button id="logoutBtn" style="background:#ff4d6d;padding:8px 14px;border-radius:14px;border:none;color:#fff;cursor:pointer;" onclick="localStorage.clear();location.reload()">Logout</button></div>
    <div id="messages"></div>
    <div class="composer">
      <input id="textInput" placeholder="Type message"/>
      <button onclick="Kiko.sendTextMessage(textInput.value);textInput.value=''">Send</button>
      <input type="file" id="fileInput" accept="image/*,video/*" hidden/>
      <button onclick="fileInput.click()">📎</button>
    </div>
  </div>
</div>

<script>
fileInput.onchange=()=>{if(fileInput.files[0])Kiko.uploadAndSendFile(fileInput.files[0])};
</script>
</body>
</html>
